{# ==============================================================
   BLOC D’UN NIVEAU — Version compacte & premium (CORRIGÉ)
   ============================================================== #}

{% set TASKS = [
    { code: 'C1',  label: '1 élément manquant',        icon: 'bi-1-circle' },
    { code: 'C2',  label: '2 éléments manquants',      icon: 'bi-2-circle' },
    { code: 'REC', label: 'Reconstitution d’un fait',  icon: 'bi-shuffle' },
    { code: 'ID',  label: 'Validation d’un fait',      icon: 'bi-check2-circle' },
    { code: 'MEMB',label: 'Identification des résultats', icon: 'bi-eye' }
] %}

{# -------------------
   SERIALISATION TÂCHES — CORRECTION CRITIQUE
   Doctrine renvoie une ArrayCollection => on convertit proprement
   -------------------- #}

{% set tasksArray = [] %}
{% for t in niveau.taches %}
    {% set tasksArray = tasksArray|merge([{
        id: t.id,
        taskType: t.taskType,
        targets: t.targets,
        answerModality: t.answerModality,
        nbIncorrectChoices: t.nbIncorrectChoices,
        nbCorrectChoices: t.nbCorrectChoices,
        nbFacts: t.nbFacts,
        sourceVariation: t.sourceVariation,
        target: t.target,
        timeMaxSecond: t.timeMaxSecond,
        successiveSuccessesToReach: t.successiveSuccessesToReach,
        repartitionPercent: t.repartitionPercent
    }]) %}
{% endfor %}

<div class="level-card"
     data-level-id="{{ niveau.id }}"
     data-equal-position="{{ niveau.resultLocation }}"
     data-factor-position="{{ niveau.leftOperand }}"
     data-interval-min="{{ niveau.intervalMin }}"
     data-interval-max="{{ niveau.intervalMax }}"
     data-success-criteria="{{ niveau.successCompletionCriteria }}"
     data-encounter-criteria="{{ niveau.encounterCompletionCriteria }}"
     data-tables='{{ niveau.tables|json_encode }}'
     data-tasks='{{ tasksArray|json_encode }}'>

    {# ============================================================
       HEADER
       ============================================================ #}
    <div class="level-header d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-3">
            <div class="level-title">Niveau {{ index }}</div>
            <input type="text" class="form-control form-control-sm level-name-input"
                   value="{{ niveau.name }}">
        </div>

        <div class="d-flex align-items-center gap-3">
            <div class="level-facts text-end">
                <div class="facts-label">FAITS</div>
                <div class="facts-value" data-facts-count>0</div>
            </div>

            <button type="button" class="btn btn-sm toggle-level-details">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>
    </div>

    <div class="level-body">

        {# ============================================================
           TÂCHES
           ============================================================ #}
        <div class="level-section-title mt-3">Tâches</div>

        <div class="tasks-line">
            {% for task in TASKS %}
                {% set activeTask = tasksArray|filter(t => t.taskType == task.code)|first %}

                <button type="button"
                        class="task-card {{ activeTask ? 'task-active' : '' }}"
                        data-task-type="{{ task.code }}">

                    <div class="task-icon"><i class="bi {{ task.icon }}"></i></div>
                    <div class="task-text">
                        <div class="task-code">{{ task.code }}</div>
                        <div class="task-label">{{ task.label }}</div>
                    </div>
                </button>
            {% endfor %}
        </div>

        {# ============================================================
           CRITÈRES DE COMPLÉTION
           ============================================================ #}
        <div class="level-section-title mt-4">Critère de complétion du niveau</div>

        <div class="completion-row">
            <div class="completion-block">
                <div class="small fw-bold">% Vus</div>
                <input type="range" min="0" max="100"
                       class="form-range completion-seen"
                       value="{{ niveau.encounterCompletionCriteria }}">
                <div class="completion-value completion-seen-value">
                    {{ niveau.encounterCompletionCriteria }}%
                </div>
            </div>

            <div class="completion-block">
                <div class="small fw-bold">% Succès</div>
                <input type="range" min="0" max="100"
                       class="form-range completion-success"
                       value="{{ niveau.successCompletionCriteria }}">
                <div class="completion-value completion-success-value">
                    {{ niveau.successCompletionCriteria }}%
                </div>
            </div>
        </div>

        {# ============================================================
           POSITIONS
           ============================================================ #}
        <div class="positions-row">

            <div class="position-col">
                <h6>Position de l’égal</h6>

                <div class="position-box equal-position-group">

                    <div class="position-btn" data-value="LEFT">
                        <span class="exemple">4 = 2 × 2</span>
                        <span class="label">Gauche</span>
                    </div>

                    <div class="position-btn" data-value="MIX">
                        <span class="exemple">/</span>
                        <span class="label">Les deux</span>
                    </div>

                    <div class="position-btn" data-value="RIGHT">
                        <span class="exemple">2 × 2 = 4</span>
                        <span class="label">Droite</span>
                    </div>

                </div>
            </div>

            <div class="position-col">
                <h6>Position du facteur</h6>

                <div class="position-box factor-position-group">

                    <div class="position-btn" data-value="OPERAND_TABLE">
                        <span class="exemple">2 × ? = 4</span>
                        <span class="label">Gauche</span>
                    </div>

                    <div class="position-btn" data-value="MIX">
                        <span class="exemple">/</span>
                        <span class="label">Les deux</span>
                    </div>

                    <div class="position-btn" data-value="TABLE_OPERAND">
                        <span class="exemple">? × 2 = 4</span>
                        <span class="label">Droite</span>
                    </div>

                </div>
            </div>
        </div>

        {# ============================================================
           INTERVALLE DES FACTEURS
           ============================================================ #}
        <div class="level-section-title mt-4">Intervalle des facteurs</div>

        <div class="range-double"
             data-min="{{ niveau.intervalMin }}"
             data-max="{{ niveau.intervalMax }}">

            <div class="range-track"></div>
            <div class="range-range"></div>

            <div class="range-handle range-handle-min"></div>
            <div class="range-handle range-handle-max"></div>
        </div>

        <div class="interval-values mt-1">
            <span data-interval-min>{{ niveau.intervalMin }}</span> –
            <span data-interval-max>{{ niveau.intervalMax }}</span>
        </div>

        {# ============================================================
           DELETE LEVEL
           ============================================================ #}
        <div class="text-end mt-4">
            <button class="btn btn-outline-danger btn-sm delete-level-btn">
                <i class="bi bi-trash"></i> Supprimer le niveau
            </button>
        </div>

    </div>
</div>
