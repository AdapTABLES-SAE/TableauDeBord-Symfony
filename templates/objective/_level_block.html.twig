{# ==============================================================
   BLOC D’UN NIVEAU — version simple & propre
   ============================================================== #}

{% set TASKS = [
    { code: 'C1',   label: '1 élément manquant',         icon: 'bi-1-circle' },
    { code: 'C2',   label: '2 éléments manquants',       icon: 'bi-2-circle' },
    { code: 'REC',  label: 'Reconstitution d’un fait',   icon: 'bi-shuffle' },
    { code: 'ID',   label: 'Validation d’un fait',       icon: 'bi-check2-circle' },
    { code: 'MEMB', label: 'Identification des résultats', icon: 'bi-eye' }
] %}

<div class="level-card"
     data-level-id="{{ niveau.id }}"
     data-equal-position="{{ niveau.resultLocation }}"
     data-factor-position="{{ niveau.leftOperand }}"
     data-interval-min="{{ niveau.intervalMin }}"
     data-interval-max="{{ niveau.intervalMax }}"
     data-success-criteria="{{ niveau.successCompletionCriteria }}"
     data-encounter-criteria="{{ niveau.encounterCompletionCriteria }}"
     data-tables="{{ niveau.tables|json_encode }}"
     data-tasks="{{ niveau.taches|json_encode }}">

    {# ==================================================
       HEADER DU NIVEAU
       ================================================== #}
    <div class="level-header d-flex justify-content-between align-items-center">

        <div class="d-flex align-items-center gap-3">
            <div class="level-title">Niveau {{ index }}</div>

            <input type="text"
                   class="form-control form-control-sm level-name-input"
                   value="{{ niveau.name }}"
                   placeholder="Nom du niveau">
        </div>

        <div class="d-flex align-items-center gap-3">
            <div class="level-facts">
                <div class="facts-label">FAITS</div>
                <div class="facts-value" data-facts-count>0</div>
            </div>

            <button type="button" class="btn btn-sm toggle-level-details">
                <i class="bi bi-chevron-down"></i>
            </button>
        </div>

    </div>


    <div class="level-body">

        {# ==================================================
           TÂCHES EN UNE SEULE LIGNE
           ================================================== #}
        <div class="level-section-title mt-3">Tâches</div>

        <div class="tasks-row-single">
            {% for task in TASKS %}
                {% set isActive = niveau.taches|filter(t => t.taskType == task.code)|first %}
                <button type="button"
                        class="task-card {{ isActive ? 'task-active' : '' }}"
                        data-task-type="{{ task.code }}">

                    <div class="task-card-icon">
                        <i class="bi {{ task.icon }}"></i>
                    </div>

                    <div class="task-card-title">{{ task.code }}</div>
                    <div class="task-card-desc">{{ task.label }}</div>
                </button>
            {% endfor %}
        </div>


        {# ==================================================
           CRITÈRES DE COMPLÉTION
           ================================================== #}
        <div class="level-section-title mt-4">Critère de complétion du niveau</div>

        <div class="completion-pair">

            <div class="completion-item">
                <label class="form-label small">% Vus</label>
                <input type="range" min="0" max="100"
                       class="form-range crit-success-slider"
                       value="{{ niveau.encounterCompletionCriteria }}">

                <div class="criteria-value small">
                    <span id="crit_seen_val_{{ niveau.id }}">{{ niveau.encounterCompletionCriteria }}%</span>
                </div>
            </div>

            <div class="completion-item">
                <label class="form-label small">% Succès</label>
                <input type="range" min="0" max="100"
                       class="form-range crit-encounter-slider"
                       value="{{ niveau.successCompletionCriteria }}">

                <div class="criteria-value small">
                    <span id="crit_enc_val_{{ niveau.id }}">{{ niveau.successCompletionCriteria }}%</span>
                </div>
            </div>

        </div>


        {# ==================================================
           POSITIONS
           ================================================== #}
        <div class="level-section-title mt-4">Position du “=”</div>

        <div class="position-group equal-position-group">
            <div class="position-btn" data-value="LEFT">
                <div class="pos-equation">4 × 2 = 8</div>
                <div class="pos-label">Gauche</div>
            </div>

            <div class="position-btn" data-value="MIX">
                <div class="pos-equation">4 × 2 = 8</div>
                <div class="pos-label">Les deux</div>
            </div>

            <div class="position-btn" data-value="RIGHT">
                <div class="pos-equation">2 × 2 = 4</div>
                <div class="pos-label">Droite</div>
            </div>
        </div>


        <div class="level-section-title mt-4">Position du facteur</div>

        <div class="position-group factor-position-group">
            <div class="position-btn" data-value="OPERAND_TABLE">
                <div class="pos-equation">2 × ? = 4</div>
                <div class="pos-label">Gauche</div>
            </div>

            <div class="position-btn" data-value="MIX">
                <div class="pos-equation">? × 2 = 4</div>
                <div class="pos-label">Les deux</div>
            </div>

            <div class="position-btn" data-value="TABLE_OPERAND">
                <div class="pos-equation">? × 2 = 4</div>
                <div class="pos-label">Droite</div>
            </div>
        </div>



        {# ==================================================
           INTERVALLE
           ================================================== #}
        <div class="level-section-title mt-4">Intervalle des facteurs</div>

        <div class="range-double mt-1"
             data-min="{{ niveau.intervalMin }}"
             data-max="{{ niveau.intervalMax }}">

            <div class="range-track"></div>
            <div class="range-range"></div>

            <div class="range-handle range-handle-min"></div>
            <div class="range-handle range-handle-max"></div>
        </div>

        <div class="interval-values mt-1">
            <span data-interval-min>{{ niveau.intervalMin }}</span> –
            <span data-interval-max>{{ niveau.intervalMax }}</span>
        </div>


        {# ==================================================
           DELETE
           ================================================== #}
        <div class="text-end mt-4">
            <button class="btn btn-outline-danger btn-sm delete-level-btn">
                <i class="bi bi-trash"></i> Supprimer le niveau
            </button>
        </div>

    </div>

</div>
