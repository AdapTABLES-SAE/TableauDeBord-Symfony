{% extends 'base.html.twig' %}

{% block title %}Fiche Élève - AdapTABLES{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/student_view.css') }}">
{% endblock %}

{% block body %}
    {% include 'components/header.html.twig' with {
        breadcrumb_items: [
            {'label': 'Mes Classes', 'url': path('class_dashboard')},
            {'label': 'Fiche Élève', 'url': '#'}
        ]
    } %}

    <div class="page-wrapper mt-3 py-4">

        <!-- Bloc principal -->
        <div class="container card shadow section-card p-4">

            <!-- Section Élève -->
            <div class="section-title mb-3">
                <i class="bi bi-mortarboard-fill me-2"></i> Élève :
            </div>

            <form id="studentForm" method="post" class="mb-4">
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Prénom</label>
                        <input type="text" id="prenomEleve" name="prenomEleve"
                               value="{{ eleve.prenomEleve }}" class="form-control form-control-lg">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Nom</label>
                        <input type="text" id="nomEleve" name="nomEleve"
                               value="{{ eleve.nomEleve }}" class="form-control form-control-lg">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Classe</label>
                        <input type="text" value="{{ classe.name }}" readonly
                               class="form-control form-control-lg readonly-field">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Identifiant</label>
                        <input type="text" value="{{ eleve.learnerId }}" readonly
                               class="form-control form-control-lg readonly-field">
                        <div class="form-text">Impossible de modifier l’identifiant</div>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" id="saveButton" class="btn btn-violet px-4" disabled>
                        <i class="bi bi-save2 me-1"></i> Enregistrer
                    </button>
                    <button type="button" class="btn btn-danger ms-2">
                        <i class="bi bi-trash me-1"></i> Supprimer l'élève
                    </button>
                </div>
            </form>

            <!-- Entrainement attribué -->
            <div class="section-title mb-3">
                <i class="bi bi-bullseye me-2"></i> Entrainement attribué :
            </div>

            <div class="d-flex align-items-center mb-4">
                <div class="flex-grow-1">
                    <input type="text"
                           id="entrainementActuel"
                           class="form-control form-control-lg readonly-field"
                           value="{{ entrainementActuel ? entrainementActuel.learningPathID : 'Aucun entraînement attribué' }}"
                           readonly>
                </div>
                <button type="button" class="btn btn-violet ms-3"
                        data-bs-toggle="modal" data-bs-target="#entrainementModal">
                    <i class="bi bi-gear-fill me-1"></i>
                </button>
            </div>

            <!-- Section Progression -->
            <div class="section-title mb-3">
                <i class="bi bi-bar-chart-fill me-2"></i> Progression élève :
            </div>

            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#training">
                        Progression Entraînements
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#game">Progression jeu</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#store">Équipements</button>
                </li>
            </ul>

            <div class="tab-content bg-white rounded-3 p-4 shadow-sm">
                <div class="tab-pane fade show active" id="training">

                    {% if entrainementActuel is null %}
                        <p class="text-muted fst-italic">
                            Aucun entraînement n’est attribué à cet élève pour le moment.
                        </p>

                    {% elseif trainingProgress is empty %}
                        <p class="text-muted fst-italic">
                            Aucune donnée de progression disponible pour cet entraînement.
                        </p>

                    {% else %}

                        <div class="training-progress-wrapper">
                            <div class="accordion" id="trainingProgressAccordion">

                                {% for obj in trainingProgress %}
                                    <div class="accordion-item progress-accordion-item mb-3">
                                        <h2 class="accordion-header" id="heading-obj-{{ loop.index }}">
                                            <button class="accordion-button collapsed d-flex align-items-center"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#collapse-obj-{{ loop.index }}"
                                                    aria-expanded="false"
                                                    aria-controls="collapse-obj-{{ loop.index }}">

                                                <div class="d-flex align-items-center flex-grow-1">
                                                    <i class="bi bi-bullseye me-2 text-violet"></i>
                                                    <span class="fw-bold">{{ obj.name }}</span>
                                                </div>

                                                <div class="ms-auto text-end">
                                                    <span class="badge bg-violet objective-level-count">
                                                        {{ obj.levels|length }} niveau(x)
                                                    </span>
                                                </div>
                                            </button>
                                        </h2>

                                        <div id="collapse-obj-{{ loop.index }}"
                                             class="accordion-collapse collapse"
                                             aria-labelledby="heading-obj-{{ loop.index }}"
                                             data-bs-parent="#trainingProgressAccordion">
                                            <div class="accordion-body">

                                                {% for level in obj.levels %}
                                                    <div class="progress-level-block mb-3 p-3 rounded-3">

                                                        <!-- En-tête du niveau -->
                                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                                            <div>
                                                                <div class="fw-semibold">{{ level.name }}</div>
                                                                <div class="text-muted small">{{ level.levelId }}</div>
                                                            </div>

                                                            <div class="text-end">
                                                                {% if level.encounters is null %}
                                                                    <span class="badge bg-secondary">
                                                                        Niveau non disponible
                                                                    </span>
                                                                {% elseif level.encounters == 0 %}
                                                                    <span class="badge badge-outline-violet text-violet">
                                                                        Jamais joué
                                                                    </span>
                                                                {% else %}
                                                                    <span class="badge bg-violet">
                                                                        {{ (level.successPercent ?? 0)|round(0, 'floor') }}% de réussite
                                                                    </span>
                                                                {% endif %}
                                                            </div>
                                                        </div>

                                                        {% if level.encounters is not null %}
                                                            {# Barre de progression globale du niveau (succès) #}
                                                            <div class="progress small mb-2">
                                                                <div class="progress-bar bg-violet"
                                                                     role="progressbar"
                                                                     style="width: {{ level.successPercent ?? 0 }}%;"
                                                                     aria-valuenow="{{ level.successPercent ?? 0 }}"
                                                                     aria-valuemin="0"
                                                                     aria-valuemax="100">
                                                                </div>
                                                            </div>

                                                            {# Stats globales du niveau (comme dans l’ancienne vue) #}
                                                            <div class="row small text-muted mb-3 level-global-stats">
                                                                <div class="col-6">
                                                                    <div class="text-uppercase stat-label">Faits rencontrés</div>
                                                                    <div class="fw-semibold">
                                                                        {{ (level.encounters ?? 0)|number_format(0) }}%
                                                                    </div>
                                                                </div>
                                                                <div class="col-6 text-end">
                                                                    <div class="text-uppercase stat-label">Succès</div>
                                                                    <div class="fw-semibold">
                                                                        {{ (level.successPercent ?? 0)|number_format(0) }}%
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {# Liste des tâches du niveau #}
                                                            {% if level.tasks is not empty %}
                                                                <div class="tasks-header small text-muted mb-1">
                                                                    <i class="bi bi-clipboard-check me-1"></i>
                                                                    Tâches du niveau
                                                                </div>

                                                                <ul class="list-unstyled small mb-0">
                                                                    {% for task in level.tasks %}
                                                                        <li class="d-flex justify-content-between task-row py-1">
                                                                            <span>
                                                                                <span class="badge bg-light text-dark me-1">
                                                                                    {{ task.typeTask }}
                                                                                </span>
                                                                                {{ task.idTask }}
                                                                            </span>
                                                                            <span class="text-muted">
                                                                                Faits : {{ (task.currentEncounters ?? 0)|number_format(0) }}%
                                                                                — Succès : {{ (task.currentSuccess ?? 0)|number_format(0) }}%
                                                                            </span>
                                                                        </li>
                                                                    {% endfor %}
                                                                </ul>
                                                            {% endif %}
                                                        {% endif %}

                                                    </div>
                                                {% endfor %}

                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}

                            </div>
                        </div>

                    {% endif %}
                </div>

                <div class="tab-pane fade" id="game"><p class="text-muted">Contenu à venir...</p></div>
                <div class="tab-pane fade" id="store"><p class="text-muted">Contenu à venir...</p></div>
            </div>
        </div>
    </div>

    <!-- Modal sélection d'entraînement -->
    <div class="modal fade" id="entrainementModal" tabindex="-1" aria-labelledby="entrainementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg border-0">
                <div class="modal-header bg-violet text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-bullseye me-2"></i>Choisir un entraînement à attribuer
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>

                <div class="modal-body bg-light">
                    <div class="row g-3">

                        {# Carte spéciale : Aucun entraînement #}
                        <div class="col-md-6 col-lg-4">
                            <div class="training-card card h-100 border-0 shadow-sm text-center hover-card" data-id="none">
                                <div class="card-body py-4">
                                    <div class="mb-2">
                                        <i class="bi bi-slash-circle text-danger fs-2"></i>
                                    </div>

                                    <h6 class="card-title fw-bold text-danger">Aucun entraînement</h6>

                                    <div class="training-summary mt-3">
                                        <div class="summary-item text-muted small">
                                            <i class="bi bi-info-circle me-1"></i>
                                            <span>Retire tout entraînement actuellement attribué à cet élève.</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="card-footer bg-transparent border-0">
                                    <button type="button" class="btn btn-outline-danger w-100 fw-semibold select-entrainement">
                                        <i class="bi bi-x-circle me-1"></i>Retirer l'entraînement
                                    </button>
                                </div>
                            </div>
                        </div>

                        {# Entraînements existants #}
                        {% if entrainements is not empty %}
                            {% for e in entrainements %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="training-card card h-100 border-0 shadow-sm text-center hover-card" data-id="{{ e.id }}">
                                        <div class="card-body py-4">
                                            <div class="mb-2">
                                                <i class="bi bi-bookmark-star text-violet fs-2"></i>
                                            </div>

                                            <h6 class="card-title fw-bold text-violet">{{ e.learningPathID }}</h6>

                                            {% set totalLevels = 0 %}
                                            {% set totalTasks = 0 %}
                                            {% for obj in e.objectifs %}
                                                {% set totalLevels = totalLevels + obj.niveaux|length %}
                                                {% for niv in obj.niveaux %}
                                                    {% set totalTasks = totalTasks + niv.taches|length %}
                                                {% endfor %}
                                            {% endfor %}

                                            <div class="training-summary mt-3">
                                                <div class="summary-item">
                                                    <i class="bi bi-bullseye text-violet me-1"></i>
                                                    <span>{{ e.objectifs|length }} Objectif(s)</span>
                                                </div>
                                                <div class="summary-item">
                                                    <i class="bi bi-layers text-violet me-1"></i>
                                                    <span>{{ totalLevels }} Niveau(x)</span>
                                                </div>
                                                <div class="summary-item">
                                                    <i class="bi bi-puzzle text-violet me-1"></i>
                                                    <span>{{ totalTasks }} Tâche(s)</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card-footer bg-transparent border-0">
                                            <button type="button" class="btn btn-violet w-100 fw-semibold select-entrainement">
                                                <i class="bi bi-check-circle me-1"></i>Attribuer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    {% if entrainements is empty %}
                        <p class="text-center text-muted my-4">
                            Aucun entraînement disponible pour le moment, mais vous pouvez tout de même retirer
                            l’entraînement actuel de l’élève.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# Toast notification avec variables personnalisables #}
    {% include 'components/toast.html.twig' with {
        toast_success_title: "Élève mis à jour",
        toast_success_message: "Les informations ont bien été enregistrées.",
        toast_error_title: "Erreur de mise à jour",
        toast_error_message: "Impossible d’enregistrer les modifications."
    } %}

    <script type="module" src="{{ asset('js/student_tabs.js') }}"></script>
{% endblock %}
