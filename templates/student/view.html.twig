{% extends 'base.html.twig' %}

{% block title %}Fiche Élève - AdapTABLES{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ asset('css/student_view.css') }}">
{% endblock %}

{% block body %}
    <div class="page-wrapper py-4">

        <!-- Logo + titre -->
        <div class="text-center mb-4">
            <img src="{{ asset('logo.png') }}" alt="AdapTABLES" class="logo mb-2">
        </div>

        <!-- Bloc principal -->
        <div class="container card shadow section-card p-4">

            <!-- Section Élève -->
            <div class="section-title mb-3">
                <i class="bi bi-mortarboard-fill me-2"></i> Élève :
            </div>

            <form id="studentForm" method="post" class="mb-4">
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Prénom</label>
                        <input type="text" id="prenomEleve" name="prenomEleve"
                               value="{{ eleve.prenomEleve }}" class="form-control form-control-lg">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Nom</label>
                        <input type="text" id="nomEleve" name="nomEleve"
                               value="{{ eleve.nomEleve }}" class="form-control form-control-lg">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Classe</label>
                        <input type="text" value="{{ classe.name }}" readonly
                               class="form-control form-control-lg readonly-field">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Identifiant</label>
                        <input type="text" value="{{ eleve.learnerId }}" readonly
                               class="form-control form-control-lg readonly-field">
                        <div class="form-text">Impossible de modifier l’identifiant</div>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" id="saveButton" class="btn btn-violet px-4" disabled>
                        <i class="bi bi-save2 me-1"></i> Enregistrer
                    </button>
                    <button type="button" class="btn btn-danger ms-2">
                        <i class="bi bi-trash me-1"></i> Supprimer l'élève
                    </button>
                </div>
            </form>

            <!-- Entrainement attribué -->
            <div class="section-title mb-3">
                <i class="bi bi-bullseye me-2"></i> Entrainement attribué :
            </div>

            <div class="d-flex align-items-center mb-4">
                <div class="flex-grow-1">
                    <input type="text"
                           id="entrainementActuel"
                           class="form-control form-control-lg readonly-field"
                           value="{{ entrainementActuel ? entrainementActuel.learningPathID : 'Aucun entraînement attribué' }}"
                           readonly>
                </div>
                <button type="button" class="btn btn-violet ms-3"
                        data-bs-toggle="modal" data-bs-target="#entrainementModal">
                    <i class="bi bi-gear-fill me-1"></i>
                </button>
            </div>

            <!-- Section Progression -->
            <div class="section-title mb-3">
                <i class="bi bi-bar-chart-fill me-2"></i> Progression élève :
            </div>

            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#training">Progression Entraînements</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#game">Progression jeu</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#store">Équipements</button>
                </li>
            </ul>

            <div class="tab-content bg-white rounded-3 p-4 shadow-sm">
                <div class="tab-pane fade show active" id="training">
                    <p class="text-muted fst-italic">Contenu à venir...</p>
                </div>
                <div class="tab-pane fade" id="game"><p class="text-muted">Contenu à venir...</p></div>
                <div class="tab-pane fade" id="store"><p class="text-muted">Contenu à venir...</p></div>
            </div>
        </div>
    </div>

    <!-- Modal sélection d'entraînement -->
    <div class="modal fade" id="entrainementModal" tabindex="-1" aria-labelledby="entrainementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg border-0">
                <div class="modal-header bg-violet text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-bullseye me-2"></i>Choisir un entraînement à attribuer
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>

                <div class="modal-body bg-light">
                    {% if entrainements is not empty %}
                        <div class="row g-3">
                            {% for e in entrainements %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="training-card card h-100 border-0 shadow-sm text-center hover-card" data-id="{{ e.id }}">
                                        <div class="card-body py-4">
                                            <div class="mb-2">
                                                <i class="bi bi-bookmark-star text-violet fs-2"></i>
                                            </div>

                                            <h6 class="card-title fw-bold text-violet">{{ e.learningPathID }}</h6>

                                            {% set totalLevels = 0 %}
                                            {% set totalTasks = 0 %}
                                            {% for obj in e.objectifs %}
                                                {% set totalLevels = totalLevels + obj.niveaux|length %}
                                                {% for niv in obj.niveaux %}
                                                    {% set totalTasks = totalTasks + niv.taches|length %}
                                                {% endfor %}
                                            {% endfor %}

                                            <div class="training-summary mt-3">
                                                <div class="summary-item">
                                                    <i class="bi bi-bullseye text-violet me-1"></i>
                                                    <span>{{ e.objectifs|length }} Objectif(s)</span>
                                                </div>
                                                <div class="summary-item">
                                                    <i class="bi bi-layers text-violet me-1"></i>
                                                    <span>{{ totalLevels }} Niveau(x)</span>
                                                </div>
                                                <div class="summary-item">
                                                    <i class="bi bi-puzzle text-violet me-1"></i>
                                                    <span>{{ totalTasks }} Tâche(s)</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card-footer bg-transparent border-0">
                                            <button type="button" class="btn btn-violet w-100 fw-semibold select-entrainement">
                                                <i class="bi bi-check-circle me-1"></i>Attribuer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <p class="text-center text-muted my-4">Aucun entraînement disponible pour le moment.</p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>


    <!-- Toast Notification -->
    <div id="toast" class="custom-toast">
        <button class="close-btn" aria-label="Fermer">&times;</button>
        <div class="toast-title"><i class="bi bi-check-circle-fill"></i><span id="toastTitle">La création est réussie</span></div>
        <div class="toast-message" id="toastMessage">L’élève a bien été mis à jour dans la base de données.</div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ asset('js/student_tabs.js') }}"></script>
{% endblock %}
