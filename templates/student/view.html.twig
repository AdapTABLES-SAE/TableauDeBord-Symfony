{% extends 'base.html.twig' %}

{% block title %}Fiche Élève - AdapTABLES{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('css/vue_eleve/student_view.css') }}">
    <link rel="stylesheet" href="{{ asset('css/vue_eleve/equipement.css') }}">
{% endblock %}

{% block body %}
    {% include 'components/header.html.twig' with {
        breadcrumb_items: [
            {'label': 'Classes', 'url': path('class_dashboard', {'target': 'classrooms'})},
            {'label': classe.name},
            {'label': 'Eleves'},
            {'label': eleve.prenomEleve ~ ' ' ~ eleve.nomEleve, 'url': "#"},
        ]
    } %}

    <div class="page-wrapper mt-3 py-4">

        <!-- Bloc principal -->
        <div class="container card shadow section-card p-4">

            <!-- Section Élève -->
            <div class="section-title mb-3">
                <i class="bi bi-mortarboard-fill me-2"></i> Élève :
            </div>

            <form id="studentForm" method="post" class="mb-4">
                <div class="row g-3 mb-4">
                    <div class="col-md-6">
                        <label class="form-label">Prénom</label>
                        <input type="text" id="prenomEleve" name="prenomEleve"
                               value="{{ eleve.prenomEleve }}" class="form-control form-control-lg">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Nom</label>
                        <input type="text" id="nomEleve" name="nomEleve"
                               value="{{ eleve.nomEleve }}" class="form-control form-control-lg">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Classe</label>
                        <input type="text" value="{{ classe.name }}" readonly
                               class="form-control form-control-lg readonly-field">
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Identifiant</label>
                        <input type="text" value="{{ eleve.learnerId }}" readonly
                               class="form-control form-control-lg readonly-field">
                        <div class="form-text">Impossible de modifier l’identifiant</div>
                    </div>
                </div>

                <div class="text-end">
                    <button type="submit" id="saveButton" class="btn btn-violet px-4" disabled>
                        <i class="bi bi-save2 me-1"></i> Enregistrer
                    </button>
                    <button type="button"
                         class="btn btn-danger ms-2"
                         data-bs-toggle="modal"
                         data-bs-target="#deleteStudentModal">
                        <i class="bi bi-trash me-1"></i> Supprimer l'élève
                    </button>

                </div>
            </form>

            <!-- Entrainement attribué -->
            <div class="section-title mb-3">
                <i class="bi bi-bullseye me-2"></i> Entrainement attribué :
            </div>

            <div class="d-flex align-items-center mb-4">
                <div class="flex-grow-1">
                    <input type="text"
                           id="entrainementActuel"
                           class="form-control form-control-lg readonly-field"
                           value="{{ entrainementActuel ? entrainementActuel.name : 'Aucun entraînement attribué' }}"
                           readonly>
                </div>
                <button type="button" class="btn btn-violet ms-3"
                        data-bs-toggle="modal" data-bs-target="#entrainementModal">
                    <i class="bi bi-gear-fill me-1"></i>
                </button>
            </div>

            <!-- Section Progression -->
            <div class="section-title mb-3">
                <i class="bi bi-bar-chart-fill me-2"></i> Progression élève :
            </div>

            <ul class="nav nav-tabs mb-3">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#training">
                        Progression Entraînements
                    </button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#game">Progression jeu</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#store">Équipements</button>
                </li>
            </ul>

            <div class="tab-content bg-white rounded-3 p-4 shadow-sm">
                <div class="tab-pane fade show active" id="training">

                    {% if entrainementActuel is null %}
                        <p class="text-muted fst-italic">
                            Aucun entraînement n’est attribué à cet élève pour le moment.
                        </p>

                    {% elseif trainingProgress is empty %}
                        <p class="text-muted fst-italic">
                            Aucune donnée de progression disponible pour cet entraînement.
                        </p>

                    {% else %}

                        <div class="training-progress-wrapper">
                            <div class="accordion" id="trainingProgressAccordion">

                                {% for obj in trainingProgress %}
                                    <div class="accordion-item progress-accordion-item mb-3">
                                        <h2 class="accordion-header" id="heading-obj-{{ loop.index }}">
                                            <button class="accordion-button collapsed d-flex align-items-center"
                                                    type="button"
                                                    data-bs-toggle="collapse"
                                                    data-bs-target="#collapse-obj-{{ loop.index }}"
                                                    aria-expanded="false"
                                                    aria-controls="collapse-obj-{{ loop.index }}">

                                                <div class="d-flex align-items-center flex-grow-1">
                                                    <i class="bi bi-bullseye me-2 text-violet"></i>
                                                    <span class="fw-bold">{{ obj.name }}</span>
                                                </div>

                                                <div class="ms-auto text-end">
                                                    <span class="badge bg-violet objective-level-count">
                                                        {{ obj.levels|length }} niveau(x)
                                                    </span>
                                                </div>
                                            </button>
                                        </h2>

                                        <div id="collapse-obj-{{ loop.index }}"
                                             class="accordion-collapse collapse"
                                             aria-labelledby="heading-obj-{{ loop.index }}"
                                             data-bs-parent="#trainingProgressAccordion">
                                            <div class="accordion-body">

                                                {% for level in obj.levels %}
                                                    <div class="progress-level-block mb-3 p-3 rounded-3">

                                                        <!-- En-tête du niveau -->
                                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                                            <div>
                                                                <div class="fw-semibold">{{ level.name }}</div>
                                                                <div class="text-muted small">{{ level.levelId }}</div>
                                                            </div>

                                                            <div class="text-end">
                                                                {% if level.encounters is null %}
                                                                    <span class="badge bg-secondary">
                                                                        Niveau non disponible
                                                                    </span>
                                                                {% elseif level.encounters == 0 %}
                                                                    <span class="badge badge-outline-violet text-violet">
                                                                        Jamais joué
                                                                    </span>
                                                                {% else %}
                                                                    <span class="badge bg-violet">
                                                                        {{ (level.successPercent ?? 0)|round(0, 'floor') }}% de réussite
                                                                    </span>
                                                                {% endif %}
                                                            </div>
                                                        </div>

                                                        {% if level.encounters is not null %}
                                                            {# Barre de progression globale du niveau (succès) #}
                                                            <div class="progress small mb-2">
                                                                <div class="progress-bar bg-violet"
                                                                     role="progressbar"
                                                                     style="width: {{ level.successPercent ?? 0 }}%;"
                                                                     aria-valuenow="{{ level.successPercent ?? 0 }}"
                                                                     aria-valuemin="0"
                                                                     aria-valuemax="100">
                                                                </div>
                                                            </div>

                                                            {# Stats globales du niveau (comme dans l’ancienne vue) #}
                                                            <div class="row small text-muted mb-3 level-global-stats">
                                                                <div class="col-6">
                                                                    <div class="text-uppercase stat-label">Faits rencontrés</div>
                                                                    <div class="fw-semibold">
                                                                        {{ (level.encounters ?? 0)|number_format(0) }}%
                                                                    </div>
                                                                </div>
                                                                <div class="col-6 text-end">
                                                                    <div class="text-uppercase stat-label">Succès</div>
                                                                    <div class="fw-semibold">
                                                                        {{ (level.successPercent ?? 0)|number_format(0) }}%
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            {# Liste des tâches du niveau #}
                                                            {% if level.tasks is not empty %}
                                                                <div class="tasks-header small text-muted mb-1">
                                                                    <i class="bi bi-clipboard-check me-1"></i>
                                                                    Tâches du niveau
                                                                </div>

                                                                <ul class="list-unstyled small mb-0">
                                                                    {% for task in level.tasks %}

                                                                        {# === Conversion du type de tâche === #}
                                                                        {% set taskTypeReadable = {
                                                                            'C1': '1 élément manquant',
                                                                            'C2': '2 éléments manquants',
                                                                            'MEMB': 'Connaître les résultats des tables',
                                                                            'ID': 'Identification du fait',
                                                                            'REC': 'Reconstituer le fait'
                                                                        }[task.typeTask] ?? task.typeTask %}

                                                                        {# Extraction du numéro de tâche (ex: T1, T2…) #}
                                                                        {% set raw = task.idTask %}
                                                                        {% set parts = raw|split('-') %}
                                                                        {% set last = parts|last %}
                                                                        {% set num = last starts with 'T' ? last|replace({'T':''}) : '' %}

                                                                        {# Construction du nom final #}
                                                                        {% if num != '' %}
                                                                            {% set taskName = taskTypeReadable ~ ' – Tâche ' ~ num %}
                                                                        {% else %}
                                                                            {% set taskName = taskTypeReadable %}
                                                                        {% endif %}

                                                                        <li class="d-flex justify-content-between task-row py-1">
                                                                            <span>{{ taskName }}</span>

                                                                            <span class="text-muted">
                                                                                Faits : {{ (task.currentEncounters ?? 0)|number_format(0) }}%
                                                                                — Succès : {{ (task.currentSuccess ?? 0)|number_format(0) }}%
                                                                            </span>
                                                                        </li>


                                                                    {% endfor %}

                                                                </ul>
                                                            {% endif %}
                                                        {% endif %}

                                                    </div>
                                                {% endfor %}

                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}

                            </div>
                        </div>

                    {% endif %}
                </div>

                <div class="tab-pane fade" id="game">
                    {% if learnerStats is not defined or learnerStats is empty %}
                        <p class="text-muted fst-italic">Aucune information de progression jeu disponible.</p>
                    {% else %}

                        <div class="game-stats-container mt-3">

                            <div class="row g-3">

                                {# Carte 1 : Niveau Max #}
                                <div class="col-md-4">
                                    <div class="stat-card shadow-sm p-3 rounded-4 h-100">
                                        <div class="stat-label">Niveau maximal atteint</div>
                                        <div class="stat-value text-blue">{{ learnerStats.maxLevelReached ?? 0 }}</div>
                                    </div>
                                </div>

                                {# Carte 2 : Niveaux générés #}
                                <div class="col-md-4">
                                    <div class="stat-card shadow-sm p-3 rounded-4 h-100">
                                        <div class="stat-label">Nombre de niveaux générés</div>
                                        <div class="stat-value text-blue">{{ learnerStats.nbLevelsGenerated ?? 0 }}</div>
                                    </div>
                                </div>

                                {# Carte 3 : Niveaux terminés #}
                                <div class="col-md-4">
                                    <div class="stat-card shadow-sm p-3 rounded-4 h-100">
                                        <div class="stat-label">Nombre de niveaux terminés</div>
                                        <div class="stat-value text-blue">{{ learnerStats.nbLevelsPlayedUntilEnd ?? 0 }}</div>
                                    </div>
                                </div>

                                {# Carte : Temps de jeu #}
                                <div class="col-md-4">
                                    <div class="stat-card shadow-sm p-3 rounded-4 h-100">
                                        <div class="stat-label">Temps total passé dans des donjons</div>
                                        <div class="stat-value text-blue">
                                            {{ learnerStats.totalTimeMin ?? 0 }} min
                                        </div>
                                    </div>
                                </div>

                                {# Carte : Morts #}
                                <div class="col-md-4">
                                    <div class="stat-card shadow-sm p-3 rounded-4 h-100">
                                        <div class="stat-label">Nombre de morts</div>
                                        <div class="stat-value text-red">{{ learnerStats.nbDeaths ?? 0 }}</div>
                                    </div>
                                </div>

                                {# Carte : Retours au hub #}
                                <div class="col-md-4">
                                    <div class="stat-card shadow-sm p-3 rounded-4 h-100">
                                        <div class="stat-label">Retours au hub (sans finir le donjon)</div>
                                        <div class="stat-value text-orange">{{ learnerStats.nbExits ?? 0 }}</div>
                                    </div>
                                </div>

                                {# Carte : Pièces #}
                                <div class="col-md-4">
                                    <div class="stat-card shadow-sm p-3 rounded-4 h-100">
                                        <div class="stat-label">Total de pièces collectées</div>
                                        <div class="stat-value text-gold">{{ learnerStats.totalCoins ?? 0 }}</div>
                                    </div>
                                </div>

                                {# Carte : Questions rencontrées #}
                                <div class="col-md-4">
                                    <div class="stat-card shadow-sm p-3 rounded-4 h-100">
                                        <div class="stat-label">Nombre de questions rencontrées</div>
                                        <div class="stat-value text-green">{{ learnerStats.nbQuestionsMeet ?? 0 }}</div>
                                    </div>
                                </div>

                                {# Carte : Questions réussies #}
                                <div class="col-md-4">
                                    <div class="stat-card shadow-sm p-3 rounded-4 h-100">
                                        <div class="stat-label">Nombre de réponses correctes</div>
                                        <div class="stat-value text-green">{{ learnerStats.nbCorrectAnswers ?? 0 }}</div>
                                    </div>
                                </div>

                            </div>
                        </div>

                    {% endif %}
                </div>


                <div class="tab-pane fade" id="store">
                    <div class="equipment-wrapper">

                        {% set allItems = {
                            'BAG': 'Sac',
                            'LANTERN': 'Lanterne',
                            'COMPAS': 'Boussole',
                            'BOOTS': 'Chaussures',
                            'HP': 'Fiole HP',

                            'BRACELET': 'Bracelet de force',
                            'BELT': 'Ceinture de force',
                            'GLOVE': 'Gant de force',
                            'KEYS': 'Passe-partout',
                            'COAT': 'Manteau de légèreté',
                            'CARROT': 'Carotte magique',

                            'ARMOR': 'Armure',
                            'HELMET': 'Casque',
                            'PANTS': 'Pantalon',
                            'SHIELD': 'Bouclier',
                            'SHOULDERS': 'Épaulières'
                        } %}

                        {% set inventoryMap = {} %}
                        {% for it in learnerInventory.items %}
                            {% set inventoryMap = inventoryMap|merge({ (it.id): it }) %}
                        {% endfor %}

                        <div class="equipment-wrapper">

                            <!-- OBJETS UTILES -->
                            <h5 class="equipment-category">
                                <i class="bi bi-tools me-2"></i> Objets utiles
                            </h5>

                            <div class="equipment-grid">
                                {% for id, label in allItems %}
                                    {% if id in ['BAG','LANTERN','COMPAS','BOOTS','HP'] %}
                                        {% include 'student/equipment_item.html.twig' with {
                                            item: {
                                                id: id,
                                                label: label,
                                                isBought: inventoryMap[id].isBought|default(false),
                                                isActivated: inventoryMap[id].isActivated|default(false)
                                            }
                                        } %}
                                    {% endif %}
                                {% endfor %}
                            </div>

                            <!-- CAPACITÉS -->
                            <h5 class="equipment-category mt-4">
                                <i class="bi bi-lightning-fill me-2"></i> Capacités
                            </h5>

                            <div class="equipment-grid">
                                {% for id, label in allItems %}
                                    {% if id in ['BRACELET','BELT','GLOVE','KEYS','COAT','CARROT'] %}
                                        {% include 'student/equipment_item.html.twig' with {
                                            item: {
                                                id: id,
                                                label: label,
                                                isBought: inventoryMap[id].isBought|default(false),
                                                isActivated: inventoryMap[id].isActivated|default(false)
                                            }
                                        } %}
                                    {% endif %}
                                {% endfor %}
                            </div>


                            <!-- PROTECTION -->
                            <h5 class="equipment-category mt-4">
                                <i class="bi bi-shield-shaded me-2"></i> Protection
                            </h5>

                            <div class="equipment-grid">
                                {% for id, label in allItems %}
                                    {% if id in ['ARMOR','HELMET','PANTS','SHIELD','SHOULDERS'] %}
                                        {% include 'student/equipment_item.html.twig' with {
                                            item: {
                                                id: id,
                                                label: label,
                                                isBought: inventoryMap[id].isBought|default(false),
                                                isActivated: inventoryMap[id].isActivated|default(false)
                                            }
                                        } %}
                                    {% endif %}
                                {% endfor %}
                            </div>


                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal sélection d'entraînement -->
    <div class="modal fade" id="entrainementModal" tabindex="-1" aria-labelledby="entrainementModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg border-0">
                <div class="modal-header bg-violet text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-bullseye me-2"></i>Choisir un entraînement à attribuer
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
                </div>

                <div class="modal-body bg-light">
                    <div class="row g-3">

                        {# Carte spéciale : Aucun entraînement #}
                        <div class="col-md-6 col-lg-4">
                            <div class="training-card card h-100 border-0 shadow-sm text-center hover-card" data-id="none">
                                <div class="card-body py-4">
                                    <div class="mb-2">
                                        <i class="bi bi-slash-circle text-danger fs-2"></i>
                                    </div>

                                    <h6 class="card-title fw-bold text-danger">Aucun entraînement</h6>

                                    <div class="training-summary mt-3">
                                        <div class="summary-item text-muted small">
                                            <i class="bi bi-info-circle me-1"></i>
                                            <span>Retire tout entraînement actuellement attribué à cet élève.</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="card-footer bg-transparent border-0">
                                    <button type="button"
                                            class="btn btn-outline-danger w-100 fw-semibold select-entrainement"
                                            data-name="Aucun entraînement"
                                            data-id="none">
                                        <i class="bi bi-x-circle me-1"></i>Retirer l'entraînement
                                    </button>
                                </div>
                            </div>
                        </div>

                        {# Entraînements existants #}
                        {% if entrainements is not empty %}
                            {% for e in entrainements %}
                                <div class="col-md-6 col-lg-4">
                                    <div class="training-card card h-100 border-0 shadow-sm text-center hover-card" data-id="{{ e.id }}">

                                        <button type="button"
                                                class="btn btn-sm btn-light position-absolute top-0 end-0 m-2 shadow-sm clone-training-btn"

                                            {# --- CONFIGURATION TOOLTIP --- #}
                                                data-bs-toggle="tooltip"
                                                data-bs-placement="top"
                                                title="Cloner cet entraînement pour l'assigner spécifiquement à cet élève"
                                            {# ----------------------------- #}

                                                data-training-id="{{ e.id }}"
                                                data-learner-id="{{ eleve.learnerId }}"
                                                style="z-index: 10; border-radius: 50%; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">

                                            {# J'ai mis une icône de copie qui correspond mieux à l'action "Cloner" #}
                                            <i class="bi bi-files text-primary"></i>
                                        </button>

                                        <div class="card-body py-4">
                                            <div class="mb-2">
                                                <i class="bi bi-bookmark-star text-violet fs-2"></i>
                                            </div>

                                            <h6 class="card-title fw-bold text-violet">{{ e.name }}</h6>

                                            {% set totalLevels = 0 %}
                                            {% set totalTasks = 0 %}
                                            {% for obj in e.objectifs %}
                                                {% set totalLevels = totalLevels + obj.niveaux|length %}
                                                {% for niv in obj.niveaux %}
                                                    {% set totalTasks = totalTasks + niv.taches|length %}
                                                {% endfor %}
                                            {% endfor %}

                                            <div class="training-summary mt-3">
                                                <div class="summary-item">
                                                    <i class="bi bi-bullseye text-violet me-1"></i>
                                                    <span>{{ e.objectifs|length }} Objectif(s)</span>
                                                </div>
                                                <div class="summary-item">
                                                    <i class="bi bi-layers text-violet me-1"></i>
                                                    <span>{{ totalLevels }} Niveau(x)</span>
                                                </div>
                                                <div class="summary-item">
                                                    <i class="bi bi-puzzle text-violet me-1"></i>
                                                    <span>{{ totalTasks }} Tâche(s)</span>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="card-footer bg-transparent border-0">
                                            <button type="button"
                                                    class="btn btn-violet w-100 fw-semibold select-entrainement"
                                                    data-name="{{ e.name }}"
                                                    data-id="{{ e.id }}">
                                                <i class="bi bi-check-circle me-1"></i>Attribuer
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            {% endfor %}
                        {% endif %}
                    </div>

                    {% if entrainements is empty %}
                        <p class="text-center text-muted my-4">
                            Aucun entraînement disponible pour le moment, mais vous pouvez tout de même retirer
                            l’entraînement actuel de l’élève.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {# --- Modal confirmation attribution entraînement --- #}
    <div class="modal fade" id="confirmAssignTrainingModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content rounded-4 shadow-lg border-0">

                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title fw-bold">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Confirmer l’attribution
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    <p>
                        Vous êtes sur le point d’attribuer un nouvel entraînement à cet élève.
                    </p>

                    <p class="fw-bold text-danger">
                        ⚠ Cette action réinitialisera <u>toutes les progressions de jeu</u> associées à l’entraînement actuel.
                    </p>

                    <p>
                        Entraînement sélectionné : <span id="confirm-training-name" class="fw-semibold"></span>
                    </p>
                </div>

                <div class="modal-footer border-0">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Annuler
                    </button>

                    <button type="button" class="btn btn-danger" id="confirm-assign-btn">
                        Confirmer l’attribution
                    </button>
                </div>

            </div>
        </div>
    </div>

    <!-- MODAL DELETE ELEVE -->
    <div class="modal fade" id="deleteStudentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content border-danger">

                <div class="modal-header bg-light-subtle">
                    <h5 class="modal-title text-danger fw-bold">Supprimer l'élève</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>

                <div class="modal-body">
                    Voulez-vous vraiment supprimer cet élève ?<br>
                    <strong>Cette action est irréversible.</strong>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Annuler
                    </button>
                    <button data-delete-endpoint="{{ path("delete_student", {'id': eleve.id}) }}"
                            data-redirect="{{ path("class_dashboard") }}"
                            id="confirmDeleteStudentBtn" class="btn btn-danger px-4">
                        Supprimer
                    </button>
                </div>
            </div>
        </div>
    </div>

    {# Toast notification avec variables personnalisables #}
    {% include 'components/toast.html.twig' with {
        toast_success_title: "Élève mis à jour",
        toast_success_message: "Les informations ont bien été enregistrées.",
        toast_error_title: "Erreur de mise à jour",
        toast_error_message: "Impossible d’enregistrer les modifications."
    } %}

    <script type="module" src="{{ asset('js/student_tabs.js') }}"></script>
    <script>
        window.fullInventory = {{ learnerInventory.items|json_encode|raw }};
    </script>
{% endblock %}
